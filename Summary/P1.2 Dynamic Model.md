# Controller-for-Autonomous-Vehicle

## Part One Model Setup ç³»ç»Ÿå»ºæ¨¡

### 2. Dynamic Model åŠ¨åŠ›å­¦æ¨¡å‹

### **Assumption:** 

> 1. è½¦è¾†å‰åè½®å‡å¯ä»¥è½¬åŠ¨ï¼Œå·¦å³è½®å…·æœ‰ç›¸åŒè½¬è§’ï¼Œå³å‰åè½®å¯ä»¥åˆ†åˆ«ç®€åŒ–ä¸ºå•è½¦æ¨¡å‹ **Bicycle Model**  *(æ³¨ï¼šå¯¹äº **front-wheel-only** ç³»ç»Ÿï¼Œåè½®è½¬è§’å¯è®¾ç½®ä¸º **zero**)* 
>2. è½¦è¾†è¿åŠ¨ä¸¥æ ¼é™åˆ¶åœ¨ **X-Y** äºŒç»´å¹³é¢ï¼Œå³å¿½ç•¥è½¦è¾†ä¸Šä¸‹å¡è¿åŠ¨
> 3. ä¸è¿åŠ¨å­¦æ¨¡å‹ä¸åŒï¼ŒåŠ¨åŠ›å­¦æ¨¡å‹ä¸­è½¦è¾† **é«˜é€Ÿ** è¿åŠ¨ï¼Œå‰åè½®è½¬åŠ¨äº§ç”Ÿçš„è½®èƒä¾§åè§’ä¸ä¸º **zero** ï¼Œå³å‰åè½®é€Ÿåº¦çŸ¢é‡æ–¹å‘ä¸è½¬è§’ä¸å†ä¸€è‡´
>4. è½¦è¾† **çºµå‘é€Ÿåº¦è§†ä¸ºå¸¸é‡** ï¼Œä¿æŒä½/é›¶åŠ é€Ÿåº¦è¿åŠ¨ï¼Œå¿½ç•¥è½¦è¾†åŠ é€Ÿã€å‡é€Ÿæˆ–è½¬å‘æ—¶äº§ç”Ÿçš„å‰åè½´è´Ÿè½½è½¬ç§» 
> 5. è½¦èº«ä»¥åŠæ‚¬æ¶ç³»ç»Ÿæ˜¯åˆšä½“ **rigid body** 
> 5. çºµå‘ä¸æ¨ªå‘æ§åˆ¶æ— ç›¸å…³æ€§ï¼Œè§£è€¦æ§åˆ¶

### **Parameters Definition:**

<img src="./Pictures/DynamicModel1.png" alt="DynamicModel" style="zoom:50%;" />

<img src="./Pictures/DynamicModel2.png" alt="DynamicModel" style="zoom:50%;" />

|  Parameter  |            Description             |  Parameter  |            Description             |
| :---------: | :--------------------------------: | :---------: | :--------------------------------: |
|    **O**    |          **ICR** æ—‹è½¬ä¸­å¿ƒ          |   **XY**    |         æƒ¯æ€§åæ ‡ç³» **F_I**         |
|   **xy**    |         è½¦è¾†åæ ‡ç³» **F_B**         |    **V**    |            è½¦è¾†è´¨å¿ƒé€Ÿåº¦            |
|   **V_f**   |              å‰è½®é€Ÿåº¦              |   **V_r**   |              åè½®é€Ÿåº¦              |
|   **l_f**   |              å‰æ‚¬é•¿åº¦              |   **l_r**   |              åæ‚¬é•¿åº¦              |
|    **Î²**    |             è½¦è¾†ä¾§åè§’             |    **Ïˆ**    |             è½¦è¾†èˆªå‘è§’             |
|  **F_yf**   |           ç­‰æ•ˆå‰è½®ä¾§ååŠ›           |  **F_yr**   |           ç­‰æ•ˆåè½®ä¾§ååŠ›           |
|   **Î±_f**   |             å‰è½®ä¾§åè§’             |   **Î±_r**   |             åè½®ä¾§åè§’             |
| **Î´_f (Î´)** |              å‰è½®è½¬è§’              | **Î´_r (0)** |              åè½®è½¬è§’              |
|  **ğœƒ_vf**   | å‰è½®é€Ÿåº¦çŸ¢é‡ä¸ **F_Bx** æ­£æ–¹å‘å¤¹è§’ |  **ğœƒ_vr**   | åè½®é€Ÿåº¦çŸ¢é‡ä¸ **F_Bx** æ­£æ–¹å‘å¤¹è§’ |
|  **Ïˆ_des**  | è½¦è¾†å½“å‰ä½ç½®åœ¨å‚è€ƒçº¿ä¸ŠæŠ•å½±ç‚¹èˆªå‘è§’ | **C_f/C_r** |          å‰/åè½®ä¾§ååˆšåº¦           |

***æ³¨ï¼šè½¦è¾†èˆªå‘è§’ÏˆæŒ‡è½¦ä½“åæ ‡ç³»xè½´æ­£æ–¹å‘ä¸æƒ¯æ€§åæ ‡ç³»xè½´æ­£æ–¹å‘å¤¹è§’ï¼Œè½¦è¾†ä¾§åè§’Î²æŒ‡è½¦è¾†é€Ÿåº¦çŸ¢é‡æ–¹å‘ä¸è½¦ä½“åæ ‡ç³»xè½´æ­£æ–¹å‘å¤¹è§’ï¼Œè½®èƒä¾§åè§’Î±æŒ‡è½®èƒé€Ÿåº¦çŸ¢é‡æ–¹å‘ä¸è½®èƒåæ ‡ç³»xè½´æ­£æ–¹å‘å¤¹è§’ï¼Œè¯¦ç»†å®šä¹‰å¦‚ä¸‹ï¼š***

> **Quotes from *Vehicle Dynamics and Control***
>
> (X, Y) are inertial coordinates of the location of the c.g. of the vehicle, while ***Ïˆ describes the orientation of the vehicle***. The angle Ïˆ is called **the heading angle** of the vehicle. 
>
> The velocity at the c.g. of the vehicle is denoted by V and makes an angle ***Î² with the longitudinal axis of the vehicle***. The angle Î² is called **the slip angle** of the vehicle.
>
> **The course angle** for the vehicle is Î³ = Ïˆ + Î² .
>
> **The slip angle of a tire** Î± is defined as the angle between the orientation of the tire and the  orientation of the velocity vector of the wheel.

### **State Space Equation:**

> *å»ºç«‹æ¨¡å‹ï¼Œåˆ‡å‹¿ä¸“æ³¨äºå…¬å¼çš„æ¨å¯¼ç»“æœè€Œå¿½ç•¥å…¬å¼çš„æ¨å¯¼è¿‡ç¨‹ï¼Œåˆ‡å‹¿ä¸“æ³¨äºå…¬å¼çš„æ¨å¯¼è¿‡ç¨‹è€Œå¿½ç•¥æ¨¡å‹çš„çŠ¶æ€é‡ä¸è¾“å…¥é‡ã€‚*

#### ä»¥è½¦è¾†è´¨å¿ƒä¸ºå‚è€ƒç‚¹çš„åŠ¨åŠ›å­¦æ¨¡å‹ (front-wheel-only)

##### **Step1. ç¡®è®¤æ¨¡å‹çŠ¶æ€é‡ä¸è¾“å…¥é‡**

> çŠ¶æ€é‡ä¸ºè´¨å¿ƒæ¨ªå‘ä½ç½®å˜åŒ–ç‡ä¸è½¦è¾†èˆªå‘è§’å˜åŒ–ç‡ï¼Œè¾“å…¥é‡ä¸ºå‰è½®è½¬è§’ï¼Œåè½®è½¬è§’æ’ç­‰äº **zero** ã€‚

##### **Step2. æ¨å¯¼**

> å°†ç‰›é¡¿ç¬¬äºŒå®šå¾‹åº”ç”¨äºè½¦è¾†æ²¿ **y** è½´çš„è¿åŠ¨ï¼Œå¾—ï¼š

$$
\begin{align}
\Sigma F_y=ma_y=F'_{yf}+F'_{yr} \tag{1}
\end{align}
$$

> åŒæ—¶ï¼Œæ ¹æ®è½¦è¾†ç»• **z** è½´çš„åŠ›çŸ©å¹³è¡¡ï¼Œå¾—ï¼š

$$
\begin{align}
I_z\ddot\psi=l_fF'_{yf}-l_rF'_{yr} \tag{2}
\end{align}
$$

> åˆ†æè½¦è¾†æ²¿ y è½´è¿åŠ¨çš„åŠ é€Ÿåº¦ï¼Œå¾—ï¼š

$$
\begin{align}
\Delta V_y&=V_x(t_2)sin(\Delta \psi)+V_y(t_2)cos(\Delta \psi)-V_y(t_1) \\ 
\lim\limits_{t_2\to{t_1}} {\Delta V_y\over{\Delta t}}&= \lim\limits_{\Delta t\to 0} {V_x(t_2)sin(\Delta \psi)+V_y(t_2)cos(\Delta \psi)-V_y(t_1)\over{\Delta_t}} \\
a_y&=V_x\dot\psi+\ddot y \quad \Delta \psi \to 0,sin(\Delta \psi) \to \Delta \psi,cos(\Delta \psi) \to 1 \tag{3}
\end{align}
$$

> åˆ†æè½¦è¾†è½®èƒä¾§ååŠ›ï¼Œå¾—ï¼š

$$
\begin{align}
F'_{yf}&=F_{yf}cos(\delta)-F_{xf}sin(\delta)=F_{yf} \quad \delta \to 0,sin(\delta) \to 0,cos(\delta) \to 1 \\
F'_{yr}&=F_{yr} \\
\alpha_f&=\delta-\theta_{vf} \quad 
\alpha_r=-\theta_{vr} \tag{4} \\
F'_{yf}&=2C_{\alpha f}\alpha_f \quad 
F'_{yr}=2C_{\alpha r}\alpha_r \\
tan(\theta_{vf})&={{V_y+l_f \dot\psi}\over{V_x}}=\theta_{vf} \quad
tan(\theta_{vr})={{V_y-l_r \dot\psi}\over{V_x}}=\theta_{vr} \quad V_y=\dot y
\end{align}
$$

> æ•´ç†ä¸Šè¿°å…¬å¼ï¼Œå¾—ï¼š

$$
\begin{align}
\ddot y=a_y-V_x\dot\psi&={{F'_{yf}+F'_{yr}}\over m}-V_x\dot\psi={{2C_{af}\alpha_{f}+2C_{ar}\alpha_{r}}\over m}-V_x\dot\psi \\
&={{2C_{af}(\delta-\theta_{vf})}+2C_{ar}(-\theta_{vr})\over m}-V_x\dot\psi \\
&=-{2C_{af}+2C_{ar}\over mV_x}\dot y-{2C_{af}l_f-2C_{ar}l_{r}\over mV_x}\dot\psi-V_x\dot\psi+{2C_{af}\over m}\delta \tag{5}
\end{align}
$$

$$
\begin{align}
\ddot\psi={{F'_{yf}l_f-F'_{yr}l_r}\over I_z}&={{2C_{af}\alpha_fl_f-2C_{ar}\alpha_rl_r}\over I_z} \\
&={{2C_{af}l_f(\delta-\theta_{vf})-2C_{ar}l_r(-\theta_{vr})}\over I_z} \\
&=-{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x}\dot y-{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}\dot\psi+{2C_{af}l_f\over I_z}\delta \tag{6}
\end{align}
$$

##### **Step3. The overall equations of motion**

> æ ¹æ®æ¨¡å‹çŠ¶æ€é‡ä¸è¾“å…¥é‡ï¼Œç¡®è®¤åŠ¨åŠ›å­¦æ–¹ç¨‹å¦‚ä¸‹ï¼š

$$
\begin{align}
\ddot y&=-{2C_{af}+2C_{ar}\over mV_x}\dot y-{2C_{af}l_f-2C_{ar}l_{r}\over mV_x}\dot\psi-V_x\dot\psi+{2C_{af}\over m}\delta \tag{7} \\
\ddot\psi&=-{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x}\dot y-{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}\dot\psi+{2C_{af}l_f\over I_z}\delta \tag{8}
\end{align}
$$

$$
\begin{bmatrix} 
\dot y \\ 
\ddot y \\ 
\dot \psi \\ 
\ddot \psi 
\end{bmatrix}=
\begin{bmatrix}
0 & 1 & 0 & 0 \\
0 & -{2C_{af}+2C_{ar}\over mV_x} & 0 & -{2C_{af}l_f-2C_{ar}l_{r}\over mV_x}-V_x \\
0 & 0 & 0 & 1 \\
0 & -{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x} & 0 & -{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}
\end{bmatrix}
\begin{bmatrix} 
y \\ 
\dot y \\ 
\psi \\ 
\dot \psi 
\end{bmatrix}+
\begin{bmatrix}
0 \\ 
{2C_{af}\over m} \\ 
0 \\ 
{2C_{af}l_f\over I_z}
\end{bmatrix}\delta
\tag{9}
$$

### Linearization and Discretization:

> *åœ¨è½¦è¾†åŠ¨åŠ›å­¦å»ºæ¨¡ä¸­å¾—åˆ°çš„çº¿æ€§ç³»ç»Ÿï¼Œéœ€è¦ç»è¿‡ç¦»æ•£åŒ–å¤„ç†åï¼Œåœ¨ç‰¹å®šå·¥ä½œåŒºä¸æŸå¤±åŸæœ‰ç²¾åº¦çš„åŸºç¡€ä¸Šï¼Œæ›´æ˜“äºç³»ç»Ÿæ§åˆ¶å™¨çš„è®¾è®¡ã€‚*

#### åŸºäºå‚è€ƒç³»ç»Ÿå»ºç«‹é¢å‘è¯¯å·®é‡çš„åŠ¨åŠ›å­¦æ¨¡å‹

å¯¹äºä»¥è½¦è¾†è´¨å¿ƒä¸­å¿ƒä¸ºå‚è€ƒç‚¹çš„åŠ¨åŠ›å­¦æ¨¡å‹ *(front-wheel-only)*ï¼š

##### **Step1. ç¡®è®¤æ¨¡å‹çŠ¶æ€é‡ä¸è¾“å…¥é‡**

> çŠ¶æ€é‡ä¸ºè½¦è¾†è´¨å¿ƒåˆ°å‚è€ƒçº¿çš„è·ç¦»åŠå…¶å˜åŒ–ç‡ä¸è½¦è¾†è´¨å¿ƒèˆªå‘è§’ä¸è½¦è¾†è´¨å¿ƒåœ¨å‚è€ƒçº¿ä¸Šçš„æŠ•å½±ç‚¹èˆªå‘è§’ä¹‹å·®åŠå…¶å˜åŒ–ç‡ï¼Œè¾“å…¥é‡ä¸ºå‰è½®è½¬è§’ï¼Œåè½®è½¬è§’æ’ç­‰äº **zero** ã€‚

$$
\begin{align}
\psi_{res}={V_x\over{R}} \quad e_\theta&=\psi-\psi_{res} \quad \dot e_\theta=\dot\psi-\dot\psi_{res} \tag{1} \\
\ddot e_{c.g.}=a_y-a_{res}&=\ddot y+V_x\dot\psi-V_x\dot\psi_{des}=\ddot y+V_x(\dot\psi-\dot\psi_{res})=\ddot y+V_x\dot e_{\theta} \tag{2}
\end{align}
$$

> **with constant Vx (LTI)**

$$
\dot e_{c.g.}=\dot y+V_xe_{\theta} \tag{3}
$$

> **with non-constant Vx (LPV)**

$$
\dot e_{c.g.}=\dot y+\int{V_xe_{\theta}}dt
$$

##### **Step2. æ¨å¯¼**

$$
\begin{align}
\ddot y&=\ddot e_{c.g.}-V_x\dot e_{\theta} \\ 
&=-{2C_{af}+2C_{ar}\over mV_x}(\dot e_{c.g.}-V_xe_{\theta})-({2C_{af}l_f-2C_{ar}l_{r}\over mV_x}+V_x)(\dot e_{\theta}+\dot\psi_{des})+{2C_{af}\over m}\delta \\ 
\ddot e_{c.g.}&=-{2C_{af}+2C_{ar}\over mV_x}\dot e_{c.g.}+{2C_{af}+2C_{ar}\over m}e_{\theta}-{2C_{af}l_f-2C_{ar}l_{r}\over mV_x}\dot e_{\theta}+{2C_{af}\over m}\delta \tag{4}
\end{align}
$$

$$
\begin{align}
\ddot\psi&=\ddot e_{\theta}+\ddot\psi_{des} \\
&=-{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x}(\dot e_{c.g.}-V_xe_{\theta})-{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}(\dot e_{\theta}+\dot\psi_{des})+{2C_{af}l_f\over I_z}\delta \\
\ddot e_{\theta}&=-{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x}\dot e_{c.g.}+{{2C_{af}l_f-2C_{ar}l_r}\over I_z}e_{\theta}-{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}\dot e_{\theta}+{2C_{af}l_f\over I_z}\delta \tag{5} \\
&-{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}\dot\psi_{des}-\ddot\psi_{des}
\end{align}
$$

**Step3. The overall equations of motion**

> æ ¹æ®æ¨¡å‹çŠ¶æ€é‡ä¸è¾“å…¥é‡ï¼Œç¡®è®¤åŠ¨åŠ›å­¦æ–¹ç¨‹å¦‚ä¸‹ï¼š

$$
\begin{bmatrix} 
\dot e_1 \\
\ddot e_1 \\ 
\dot e_2 \\ 
\ddot e_2 
\end{bmatrix}=
\begin{bmatrix}
0 & 1 & 0 & 0 \\
0 & -{2C_{af}+2C_{ar}\over mV_x} & {2C_{af}+2C_{ar}\over m} & -{2C_{af}l_f-2C_{ar}l_{r}\over mV_x} \\
0 & 0 & 0 & 1 \\
0 & -{{2C_{af}l_f-2C_{ar}l_r}\over I_zV_x} & {{2C_{af}l_f-2C_{ar}l_r}\over I_z} & -{{2C_{af}{l_f}^2+2C_{ar}{l_r}^2}\over I_zV_x}
\end{bmatrix}
\begin{bmatrix} 
e_1 \\ 
\dot e_1 \\ 
e_2 \\ 
\dot e_2 
\end{bmatrix}+
\begin{bmatrix}
0 \\ 
{2C_{af}\over m} \\ 
0 \\ 
{2C_{af}l_f\over I_z}
\end{bmatrix}\delta \tag{6}
$$

#### çº¿æ€§è¿ç»­ç³»ç»Ÿçš„ç¦»æ•£åŒ–

> å¯¹çŠ¶æ€è¯¯å·®é‡ï¼ˆçœŸå®ç³»ç»Ÿä¸å‚è€ƒç³»ç»Ÿä¹‹é—´çš„åå·®ï¼‰å¤„ç†åå¾—åˆ°çº¿æ€§è¿ç»­çŠ¶æ€ç©ºé—´ï¼Œç”±äºçŠ¶æ€æ–¹ç¨‹æ˜¯æ—¶é—´è¿ç»­çš„ä¸èƒ½ç›´æ¥ç”¨äºæ§åˆ¶å™¨çš„è®¾è®¡ï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œç¦»æ•£åŒ–å¤„ç†ã€‚

> æ ¹æ®ç§¯åˆ†ä¸­å€¼å®šç†ä¸­ **Î¾** å€¼å–å€¼çš„ä¸åŒï¼Œåˆ†ä¸ºå‰å‘æ¬§æ‹‰æ³•ã€åå‘æ¬§æ‹‰æ³•ä¸ä¸­ç‚¹æ¬§æ‹‰æ³•ï¼Œå¯¹(1)å¼åŒ–ç®€ååˆ†åˆ«å¯¹åº”ä¸‹æ–‡ä¸­çš„(2)(3)(4)å¼ï¼š

$$
\begin{align}
& \int _{T}^{T+dt}{\dot X}dt = \int_ {T}^{T+dt}{(AX+Bu)}dt \\
ç§¯åˆ†ä¸­å€¼å®šç†& \quad X(T+dt)-X(T) = AX(\xi)dt + Bu(\xi)dt \quad \xi\in[T,T+dt] \tag{1} \\
X(\xi)&=X(T) \\
(1) \quad X(T+dt) &= (I+Adt)X(T) + (Bdt)u(T) \tag{2} \\
X(\xi)&=X(T+dt) \\
(1) \quad X(T+dt) &= (I-Adt)^{-1}X(T) + (I-Adt)^{-1}(Bdt)u(T) \tag{3} \\
X(\xi)&=[X(T+dt)+X(T)]/2 \\
(1) \quad X(T+dt) &= (I-Adt/2)^{-1}(I+Adt/2)X(T) + (I-Adt/2)^{-1}(B\sqrt{dt})u(T) \tag{4}
\end{align}
$$
